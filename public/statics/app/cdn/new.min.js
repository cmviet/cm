(function($){'use strict';
	function validcdnname(str){
		if(str.length < 6){
			return false;
		}
		if(/^[a-zA-Z0-9-.]*$/.test(str) == false) {
		    return false;
		}
		return true;
	}
	function is_numeric(str){
	    return /^\d+$/.test(str);
	}
	function _pricefm(num){
		var out;
		if(!is_numeric(num)){
			return false;
		}
		if(num>1000000000){
			out = +((num / 1000000000).toFixed(1));
			out += 'b';
		} else if(num>1000000){
			out = +((num / 1000000).toFixed(1));
			out += 'm';
		} else if(num>1000){
			out = +((num / 1000).toFixed(1));
			out += 'k';
		} else {
			out = num;
			out += 'đ';
		}
		return out;
	}
	function _gbfm(num){
		var out;
		if(!is_numeric(num)){
			return false;
		}
		if(num>1023){
			out = +((num / 1024).toFixed(1));
			out += 'TB';
		} else {
			out = num;
			out += 'GB';
		}
		return out;
	}
	function plan_load(){
		var type = $('#cdn_type').val();
		var html;
		$.post("/cdn/ajax-list-plan", {t: type}, function(data) {
			var res = $.parseJSON(data);
			if(res.result=='success'){
				html = '<div class="row"><div class="btn-group col-md-12" data-toggle="buttons">';
				$.each(res.msg, function(){
					html += '<label class="col-md-3 col-sm-6 btn btn-default"><div class="panel-body"><div class="price">';
					html += '<div>';
					html += '<h2>'+this.name+'</h2>';
					html += '<small><strong>'+_pricefm(this.init_price)+'</strong>/tháng</small>';
					html += '</div>';
					html += '</div><table class="table table-striped"><tbody><tr><td>'+_gbfm(this.vn_gbinit)+' Việt Nam</td></tr><tr><td>'+_gbfm(this.qt_gbinit)+' Quốc tế</td></tr><tr><td>Vượt gói: '+_pricefm(this.vn_gbprice)+'/1GB/VN</td></tr><tr><td>Vượt gói: '+_pricefm(this.qt_gbprice)+'/1GB/QT</td></tr></tbody></table>';
					html += '</div>';
					html += '<input type="radio" name="plan" value="'+this.id+'">';
					html += '</label>';
				});
				html += '</div></div>';
				$("#plan_list").html(html);
			} else {
				$("#plan_list").html('<div class="alert alert-info"> <i class="fa fa-warning"></i> '+res.msg+'</div>');
				return false
			}
	    })
	}
    $("#cdn_name").keyup(function () {
        var name = $("#cdn_name").val();
        if(validcdnname(name)){
        	$("#cn_cfm").html("Hợp lệ");
        } else
        	$("#cn_cfm").html("Chưa hợp lệ");
    });
	$('#cdn_type').change(function() {
		var type = $('#cdn_type').val();
		if(!type){
			$("#plan_list").html("<div class=\"alert alert-info\"> <i class=\"fa fa-warning\"></i> Vui lòng chọn loại CDN trước! </div>");
			return false;
		}
		$("#plan_list").html("<div class=\"alert alert-info\"> <i class=\"fa fa-refresh fa-spin\"></i> Đang tải... </div>");
		plan_load();
	});
	$('#btn-click').on('click',function(){
		var type = $('#cdn_type').val();
		var plan = $('input[name=plan]:checked').val();
		var name = $('#cdn_name').val();
		var zone = $('#pushzone').html();
		if(!type || !plan || !name){
			swal('Đã có lỗi!','Chưa đủ thông tin cần thiết để xử lý yêu cầu!','error');return false
		}
		if(!validcdnname(name)){
			swal('Đã có lỗi!','Tên CDN không hợp lệ, hãy chọn tên hợp lệ','error');return false
		}
		$('#btn-click').html('<i class="fa fa-refresh fa-spin"></i> Đợi chút nha...');
		$('#btn-click').prop('disabled', true);
		$.post("/cdn/ajax-create", {p: plan, n: name, t: type, z: zone}, function(data) {
			var res = $.parseJSON(data);
			if(res.result=='error'){
				$('#btn-click').html('Thử lại lần nữa');
				$('#btn-click').prop('disabled', false);
				swal('Đã có lỗi!',res.msg,'error');return false
			}
			$('#new_cdn').html('<div class="panel"><div class="panel-heading border task_step">Đang tải...</div><div class="panel-body"><div class="progress"><div class="progress progress-striped active mb25"><div class="progress-bar animation--done" role="progressbar" style="width: 5%;"></div></div></div><div class="alert alert-info">Đang khởi tạo dịch vụ CDN '+res.name+' , rời khỏi trang không ảnh hưởng tới tiến trình!</div></div></div>');
			var current = 1;
            var step = ['', 'Đang xác nhận thanh toán...', 'Đang khởi tạo CDN mới...', 'Hoàn tất khởi tạo CDN...', 'Đang thiết lập API điều khiển...', 'Đang thiết lập API theo dõi băng thông...', 'Đang thiết lập hệ thống edge cache...', 'Hoàn tất thiết lập Cname...', 'Kiểm tra và xác nhận hoàn tất mọi bước...', 'Làm sạch tiến trình trước khi kết thúc...', 'Đang chuyển bạn tới quản lý CDN...'];
            var interval = setInterval(function(){
				$('.task_step').text(step[current]);
				$('.progress-bar').attr("style","width: "+current*10+"%");
				if(current === 10) {
		            setTimeout(function(){window.location.replace('/cdn/manager/'+res.id)}, 1000);
		        }
		        current++;
		    },3000);
        })
	});
	$('.slider').slider({value: 0, orientation: 'horizontal', range: 'min'},{
		change: function(event, ui) {
			$('#pushzone').html(ui.value);
		}
	});
	$(document).keyup(function(event){
	    if(event.keyCode == 13){
	        $('#btn-click').click();
	    }
	});
	plan_load();
})(jQuery);