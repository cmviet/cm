(function ($) {
	'use strict';
	var per_page = 30, page = 1, total_page = 1, box_checked = [], show_read = 0, noti_id = false, show_mode_text = 'Chỉ hiển thị chưa đọc';
	function reload_noti() {
		$('#main').html('<div class="alert alert-info"><i class="fa fa-refresh fa-spin"></i> Đang tải, vui lòng đợi chút...</div>');
		$("html, body").animate({ scrollTop: 0 }, "slow");
		if(noti_id){
			get_noti_content(noti_id);
		} else
			get_noti_list();
	}
	function show_error(msg) {
		$('#main').html('<div class="alert alert-danger"><i class="fa fa-warning"></i> '+msg+'</div>');
		$("html, body").animate({ scrollTop: 0 }, "slow");
	}
	function get_noti_list() {
		$.post('/account/ajax-noti-list', {r: show_read, l: per_page, p: page}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='success'){
				total_page = res.total;
				build_list(res.msg);
			} else {
				show_error(res.msg);
			}
		});
	}
	function get_noti_content(id) {
		$.post('/account/ajax-noti-content', {i: id}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='success'){
				build_content(res.msg);
			} else {
				show_error(res.msg);
			}
		});
	}
	function remove_noti() {
		if(!box_checked.length){
			return false;
		}
		swal({title: "Bạn chắc chứ?", text: "Xoá các tin nhắn sẽ không thể khôi phục lại được!", type: "warning", showCancelButton: true, confirmButtonColor: "#DD6B55", confirmButtonText: "Thực hiện", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
		    $.post('/account/ajax-remove-noti', {data: box_checked}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					reload_noti();
				} else {
					swal({title: "Đã có lỗi!", text: res.msg, timer: 4000, showConfirmButton: false});
				}
			});
		});
	}
	function read_noti() {
		if(!box_checked.length){
			return false;
		}
		swal({title: "Bạn chắc chứ?", text: "Tất cả các tin nhắn đã chọn sẽ đánh dấu là đã đọc!", type: "warning", showCancelButton: true, confirmButtonColor: "#DD6B55", confirmButtonText: "Thực hiện", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
		    $.post('/account/ajax-read-noti', {data: box_checked}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					reload_noti();
				} else {
					swal({title: "Đã có lỗi!", text: res.msg, timer: 4000, showConfirmButton: false});
				}
			});
		});
	}
	function build_list(data) {
		var html = '<div class="table-responsive"><table class="table mb0"><thead><tr><th class="col-xs-1"><div class="checkbox checkbox-primary checkbox-single"><input type="checkbox" id="check_all" aria-label="Chọn"><label></label></div></th><th class="col-xs-7">Tiêu đề</th><th class="col-xs-2">Loại</th><th class="col-xs-2 text-center">Ngày</th></tr></thead><tbody>'; 
		$.each(data, function(k, v){
			html += '<tr><td><div class="checkbox checkbox-primary checkbox-single"><input type="checkbox" name="noti_checkbox" value="'+v.id+'" aria-label="Chọn"><label></label></div></td>';
			if(v.unread){
				html += '<td><a href="javascript:;" class="noti_subject noti_unread" id="'+v.id+'">'+v.subject+'</a></td>';
			} else {
				html += '<td><a href="javascript:;" class="noti_subject" id="'+v.id+'">'+v.subject+'</a></td>';
			}
			html += '<td><span class="badge bg-'+v.type+'">'+v.type+'</span></td>';
			html += '<td>'+v.createdate+'</td></tr>';
		});
		html += '</tbody></table></div>';
		html += '<div class="col-md-12"><div class="col-md-6"><div class="pull-left">(<strong>Hiện tại:</strong> <a href="javascript:;" id="show_mode" style="color:red">'+show_mode_text+'</a>)</div></div><div class="col-md-6"><form class="form-horizontal bordered-group" role="form"><div class="form-group pull-right"><select class="form-control" id="cb_action" style="max-width:150px"><option value="">Tin đã chọn:</option><option value="asread">Đã đọc</option><option value="asremove">Xóa</option></select></div></form></div></div>';
		html += '<div class="col-md-12"><ul class="pager"><li><a href="javascript:;" id="pre_page">← Trang trước</a></li><li><a href="javascript:;">Trang '+page+'/'+total_page+'</a></li><li><a href="javascript:;" id="next_page">Trang sau →</a></li></ul></div>';
		$('#main').html(html);
	}
	function build_content(data) {
		var fa;
		if(data.type=='error'){
			fa = 'danger';
		} else {
			fa = data.type;
		}
		var html = '<div class="page-header"><h4>'+data.subject+'</h4></div>';
		html += '<div class="pull-right"><small>'+data.createdate+'</small></div><br /><br />';
        html += '<p>'+data.content+'</p><br /><br />';
		html += '<div class="col-md-12"><div class="col-md-4 pull-right"><div class="btn-group btn-group-justified"><a class="btn btn-primary" role="button" id="noti_back"><i class="fa fa-chevron-left"></i> Quay lại</a><a class="btn btn-danger" role="button" id="noti_remove"><i class="fa fa-remove"></i> Xoá tin nhắn</a></div></div></div>';
		$('#main').html(html);
	}
	function update_box_checked() {
		box_checked = [];
		$.each($('input[name="noti_checkbox"]:checked'), function(){            
            box_checked.push($(this).val());
        });
	}
	$(document).on('change', '#check_all', function() {
		$('input:checkbox').prop('checked', this.checked);
		update_box_checked();
    });
    $(document).on('change', 'input[name="noti_checkbox"]', function() {
    	update_box_checked();
    });
    $(document).on('change', '#cb_action', function() {
		var act = $('#cb_action').val();
		if(!act){
			return false;
		}
		if(!box_checked.length){
			return false;
		}
		if(act==='asread'){
			read_noti();
		} else if(act==='asremove'){
			remove_noti();
		}
    });
    $(document).on('click', '#pre_page', function() {
		if(page < 2){
			return false;
		}
		page = page - 1;
		reload_noti();
    });
    $(document).on('click', '#show_mode', function() {
		if(show_read == 0){
			show_read = 1;
			show_mode_text = 'Hiển thị toàn bộ tin';
		} else {
			show_read = 0;
			show_mode_text = 'Chỉ hiển thị chưa đọc';
		}
		reload_noti();
    });
    $(document).on('click', '#next_page', function() {
		if(page == total_page){
			return false;
		}
		page = page + 1;
		reload_noti();
    });
    $(document).on('click', '.noti_subject', function() {
    	var id = $(this).attr('id');
		if(!id){
			return false;
		}
		noti_id = id;
		reload_noti();
    });
    $(document).on('click', '#noti_back', function() {
		noti_id = false;
		reload_noti();
    });
    $(document).on('click', '#noti_remove', function() {
		if(!noti_id){
			return false;
		}
		swal({title: "Bạn chắc chứ?", text: "Xoá tin nhắn này xong sẽ không thể khôi phục lại được!", type: "warning", showCancelButton: true, confirmButtonColor: "#DD6B55", confirmButtonText: "Thực hiện", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
		    $.post('/account/ajax-remove-noti', {data: [noti_id]}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					noti_id = false;
					reload_noti();
				} else {
					swal({title: "Đã có lỗi!", text: res.msg, timer: 4000, showConfirmButton: false});
				}
			});
		});
    });
	reload_noti();
})(jQuery);