(function ($) {
	'use strict';
	var id = $('#id').val();
	var old_ns, hav = true, support_ttl = [1, 120, 300, 600, 900, 1800, 3600, 7200, 43200, 86400];
	function coloading() {
		$('#loading').show();
		$('#loading').removeClass().addClass('alert alert-success');
		$('#loading').html('<i class="fa fa-refresh fa-spin"></i> Thao tác đang được thực hiện, vui lòng đợi chút...');
		$('.btn').attr('disabled', true);
		$("html, body").animate({ scrollTop: 0 }, "slow");
	}
	function coresult(a, b) {
		$('#loading').removeClass().addClass('alert alert-'+a);
		$('#loading').html(b);
		$('.btn').attr('disabled', false);
		$('#loading').fadeTo(2000, 500).slideUp(1000, function(){
		    $('#loading').hide();
		});
	}
	function show_alert(msg) {
		$('#loading').show();
		$('#loading').removeClass().addClass('alert alert-danger');
		$('#loading').html(msg);
	}
	function update_info(a, b) {
		console.log(a + ', '+ b);
		$.post('/domain/ajax-update-info', {i: id, t: a, v: b}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='success'){
				var type = 'info';
			} else {
				var type = 'danger';
			}
			coresult(type, res.msg);
			remove_input();
		});
	}
	function remove_input() {
		$('.editable').each(function(){
			var val = $(this).find('input').val();
			$(this).html(val);
		});
		$('#save').html('Sửa');
		$('#save').attr('id', 'edit');
	}
	function get_status() {
		var status, label;
		$.getJSON('/domain/ajax-status?i='+id, function(data){
			if(data.result=='success'){
				old_ns = data.msg.old_ns;
				if(data.msg.status=='active'){
					status = 'Đang h.động';
					label = 'primary';
				} else if(data.msg.status=='pending'){
					status = 'Đợi cập nhật Name Servers';
					label = 'warning';
				}
				$('#status').html('<span class="label label-'+label+'">'+status+'</span>');
			} else {
				$('#status').html('<span class="label label-danger">Lỗi lấy t.tin</span>');
			}
			if(data.msg.status=='pending'){
				show_alert('Tên miền của bạn đang dùng cặp NS '+old_ns[0]+' và '+old_ns[1]+'. Để quản lý DNS tại CloudONE và hưởng các chức năng nâng cao khác, bạn cần đổi cặp NS sang <strong>ns1.cloudone.vn</strong> và <strong>ns2.cloudone.vn</strong>. Kiểm tra các bản ghi DNS bên dưới xem đã đúng và đủ chưa trước khi đổi Name Servers');
			}
		});
	}
	function get_dns() {
		$.getJSON('/domain/ajax-get-dns?i='+id, function(data){
			if(data.result=='success'){
				console.log(data.msg);
				if(!data.msg.length){
					hav = false;
					$('#dns_body').html('<tr><td colspan="5"><center>Chưa có bản ghi nào, hãy tạo bản ghi đầu tiên</center></td></tr>');
					return false;
				}
				$('#dns_body').html('');
				$.each(data.msg, function(k, v){
					auto_addrow(v);
				});
			} else {
				$('#dns_body').html('<tr><td colspan="5"><div class="alert alert-danger">'+data.msg+'</div></td></tr>');
			}
		});
	}
	function auto_addrow(v) {
		if(!hav){
			$('#dns_body').html('');
		}
		hav = true;
		var html = '<tr>';
		html += '<td class="record_type">'+v.type+'</td>';
		html += '<td class="record_name">'+v.name+'</td>';
		html += '<td class="record_content">'+v.content+'</td>';
		if(v.ttl==1){
			var ttl = 'Tự động';
		} else {
			var ttl = v.ttl + ' giây';
		}
		html += '<td class="record_ttl">'+ttl+'</td>';
		html += '<td><div class="pull-right"><button class="btn btn-primary btn-rcedit" record_id="'+v.id+'">Sửa</button><button class="btn btn-danger btn-rcdelete" record_id="'+v.id+'">Xóa</button></div></td>';
		html += '</tr>';
		$('#dns_body').append(html);
	}
	function auto_rmrow(element) {
		element.closest('tr').remove();
		if(!$('#dns_body').html()){
			hav = false;
			$('#dns_body').html('<tr><td colspan="5"><center>Chưa có bản ghi nào, hãy tạo bản ghi đầu tiên</center></td></tr>');
		}
	}
	function create_select_form(deft) {
		var html = '<select class="form-control" id="rc_ttl">';
		$.each(support_ttl, function(k, v){
			var title = v + ' giây';
			if(v==1){
				title = 'Tự động';
			}
			if(deft != title){
				html += '<option value="'+v+'">'+title+'</option>';
			} else {
				html += '<option value="'+v+'" selected="selected">'+title+'</option>';
			}
			
		});
		html += '</select>';
		return html;
	}
	$(document).on('click', '#edit', function() {
		$(this).attr('id', 'save');
		$(this).html('Lưu');
		$('.editable').each(function(){
			var val = $(this).html();
			var name = $(this).attr('name');
			$(this).html('');
			$(this).append('<input type="text" name="'+name+'" class="form-control update_info" value="'+val+'">');
		});
    });
    $(document).on('click', '#save', function() {
    	coloading();
    	$('.editable').each(function(){
			var val = $(this).find('input').val();
			var name = $(this).attr('name');
			update_info(name, val);
		});
		remove_input();
    });
	$(document).on('keypress', '.update_info', function(event) {
        if (event.which == 13) {
        	event.preventDefault();
            var name = $(this).attr('name');
            var val = $(this).val();
            if(val.length < 4 || !name){
            	return false;
            }
            coloading();
            update_info(name, val);
            remove_input();
        }
    });
    $(document).on('click', '#create_record', function() {
    	var json = {};
    	json['type'] = $('#type').val();
    	json['name'] = $.trim($('#name').val());
    	json['content'] = $.trim($('#value').val());
    	json['ttl'] = $('#ttl').val();
    	if(!json.type || !json.name || !json.content || !json.ttl){
    		swal({title: "Đã có lỗi", text: "Vui lòng điền đủ các thông tin cần thiết", type: "warning"});
    		return false;
    	}
    	coloading();
    	$.post('/domain/ajax-create-record?i='+id, {data: JSON.stringify(json)}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='success'){
				var type = 'info';
				auto_addrow(res.record);
			} else {
				var type = 'danger';
			}
			coresult(type, res.msg);
		});
    });
    $(document).on('click', '.btn-rcdelete', function() {
    	var elm = $(this);
    	var record_id = elm.attr('record_id');
    	swal({title: "Bạn chắc chứ?", text: "Hãy đảm bảo rằng bạn thực sự muốn thực hiện điều này!", type: "warning", showCancelButton: true, confirmButtonColor: "#DD6B55", confirmButtonText: "Thực hiện", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
			coloading();
		    $.post('/domain/ajax-remove-record', {i: id, r_id: record_id}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					var type = 'info';
					auto_rmrow(elm);
				} else {
					var type = 'danger';
				}
				coresult(type, res.msg);
			});
		});
    });
    $(document).on('click', '.btn-rcedit', function() {
    	$(this).removeClass('btn-rcedit').addClass('btn-rcupdate');
    	$(this).html('Lưu');
    	var tr = $(this).closest('tr');
    	var name = tr.find('.record_name').html();
    	var content = tr.find('.record_content').html();
    	var ttl = tr.find('.record_ttl').html();
    	tr.find('.record_name').html('<input class="form-control" id="rc_name" value="'+name+'">');
    	tr.find('.record_content').html('<input class="form-control" id="rc_content" value="'+content+'">');
    	tr.find('.record_ttl').html(create_select_form(ttl));
    });
    $(document).on('click', '.btn-rcupdate', function() {
    	var tr = $(this).closest('tr');
    	var record_id = $(this).attr('record_id');
    	var json = {};
    	json['name'] = $('#rc_name').val();
    	json['content'] = $('#rc_content').val();
    	json['ttl'] = $('#rc_ttl').val();
    	if(!json.name || !json.content || !json.ttl){
    		swal({title: "Đã có lỗi", text: "Vui lòng điền đủ các thông tin cần thiết", type: "warning"});
    		return false;
    	}
    	coloading();
    	$.post('/domain/ajax-update-record', {i: id, r_id: record_id, data: JSON.stringify(json)}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='success'){
				var type = 'info';
				tr.find('.btn-rcupdate').removeClass('btn-rcupdate').addClass('btn-rcedit');
		    	tr.find('.btn-rcedit').html('Sửa');
		    	tr.find('.record_name').html(res.record.name);
		    	tr.find('.record_content').html(res.record.content);
		    	var ttl;
		    	if(res.record.ttl==1){
		    		ttl = 'Tự động';
		    	} else {
		    		ttl = res.record.ttl + ' giây';
		    	}
		    	tr.find('.record_ttl').html(ttl);
			} else {
				var type = 'danger';
			}
			coresult(type, res.msg);
		});
    });
    get_status();
    get_dns();
})(jQuery);