(function ($) {
	'use strict';
	var cart = {}, tld = [], not_sell = [], reg_price = {}, ren_price = {}, coupon = {code: false, value: 0}, min_reg = {}, max_reg = {};
	function sbloading() {
		$('#loading').show();
		$('#loading').removeClass().addClass('alert alert-success');
		$('#loading').html('<i class="fa fa-refresh fa-spin"></i> Thao tác đang được thực hiện, vui lòng đợi chút...');
		$('.btn').attr('disabled', true);
		$("html, body").animate({ scrollTop: 0 }, "slow");
	}
	function sbresult(a, b) {
		$('#loading').removeClass().addClass('alert alert-'+a);
		$('#loading').html(b);
		$('.btn').attr('disabled', false);
		$('#loading').fadeTo(2000, 500).slideUp(1000, function(){
		    $('#loading').hide();
		});
	}
	function processing(domain, zid) {
		$('#domain_main').html('<div class="panel"><div class="panel-heading border task_step">Xác minh thông tin...</div><div class="panel-body"><div class="progress"><div class="progress progress-striped active mb25"><div class="progress-bar animation--done" role="progressbar" style="width: 5%;"></div></div></div><div class="alert alert-info">Đang khai báo tên miền '+domain+' , rời khỏi trang không ảnh hưởng tới tiến trình!</div></div></div>');
		var current = 1;
		var step = ['', 'Đang hoàn tất xác minh đơn hàng...', 'Đang thực hiện thanh toán...', 'Đã thanh toán xong, đợi nhận kết quả...', 'Xác nhận thanh toán thành công...', 'Hoàn tất các thủ tục liên quan...', 'Đợi và kiểm tra lại tình trạng tên miền sau thanh toán...', 'Hoàn tất bước mua tên miền, chuyển sang cấu hình NS...', 'Hoàn tất đặt NS server cho tên miền...', 'Làm sạch tiến trình trước khi kết thúc...', 'Đang chuyển bạn trở lại trang quản lý...'];
	    var interval = setInterval(function(){
			$('.task_step').text(step[current]);
			$('.progress-bar').attr("style","width: "+current*10+"%");
			if(current === 10) {
				setTimeout(function(){window.location.replace('/domain/manager/'+zid)}, 1000);
	        }
	        current++;
	    },3000);
	}
	function validdomain(str){
		if(str.length < 3){
			return false;
		}
		if(/^[a-zA-Z0-9-.]*$/.test(str) == false) {
		    return false;
		}
		return true;
	}
	function is_numeric(str){
	    return /^\d+$/.test(str);
	}
	function _pricefm(num){
		var out;
		if(!is_numeric(num)){
			return false;
		}
		if(num>1000000000){
			out = +((num / 1000000000).toFixed(1));
			out += 'b';
		} else if(num>1000000){
			out = +((num / 1000000).toFixed(1));
			out += 'm';
		} else if(num>1000){
			out = +((num / 1000).toFixed(1));
			out += 'k';
		} else {
			out = num;
			out += 'đ';
		}
		return out;
	}
	function add_to_cart(domain, years) {
		cart[domain] = years;
	}
	function remove_from_cart(domain) {
		delete cart[domain];
	}
	function update_sumary() {
		if($.isEmptyObject(cart)){
			$('#domain_sumary').hide();
			return false;
		}
		if($('#domain_sumary').not(':visible')){
			$('#domain_sumary').show(1000);
		}
		var html = '';
		var total_due = 0;
		$.each(cart, function(domain, years){
			var itld = url('tld', domain);
			var cost = reg_price[itld]*1 + (years - 1) * ren_price[itld];
			total_due = total_due + cost;
			html += '<tr><td>'+domain+'</td>';
			html += '<td class="text-center">'+years+' năm</td>';
			html += '<td class="text-center">'+_pricefm(cost)+'</td></tr>';
		});
		html += '<tr><td></td><td><strong>Tạm tính:</strong></td><td class="text-center">'+_pricefm(total_due)+'</td></tr>';
		if(coupon.code){
			html += '<tr><td></td><td><strong>Mã giảm giá: '+coupon.code+'</strong></td><td class="text-center"><strong id="coupon_value">Đang tính..</strong></td></tr>';
			$.post('/domain/ajax-coupon', {cop: coupon.code, cat: JSON.stringify(cart)}, function(data) {
				var res = $.parseJSON(data);
				coupon.value = res.value;
				$('#coupon_value').html('-'+_pricefm(coupon.value));
				if(coupon.value==0){
					swal({title: "Nhắc nhở", text: "Bạn đã thêm mã khuyến mãi thành công, nhưng không có tên miền nào bạn chọn mua áp dụng được mã khuyến mãi này!", type: "warning"});
				}
			});
		}
		html += '<tr><td></td><td><strong>Tổng t.toán:</strong></td><td class="text-center">'+_pricefm(total_due - coupon.value)+'</td></tr>';
		$('#domain_sum').html(html);
	}
	$('#check_btn').on('click',function(){
		var list = $('#domain_list').val();
		if(!list || list.length < 3){
			swal({title: "Đã có lỗi", text: "Hãy nhập tên miền hợp lệ vào để kiểm tra", type: "warning"});
    		return false;
		}
		var lines = list.split(/\n/);
		var array = [];
		for (var i=0; i < lines.length; i++) {
			var line = $.trim(lines[i]);
			if(validdomain(line)) {
				array.push(line);
			}
		}
		if(!array.length){
			swal({title: "Đã có lỗi", text: "Hãy nhập tên miền hợp lệ vào để kiểm tra", type: "warning"});
    		return false;
		}
		sbresult('info', 'Kết quả kiểm tra được hiển thị bên dưới');
		$('#domain_result').show(1000);
		var html = '';
		$.each(array, function(key, item){
			var itld = url('tld', item);
			html += '<tr>';
			html += '<td>'+item+'</td>';
			if(typeof itld !== "undefined"){
				itld = itld.replace('.', '_');
				html += '<td class="text-center tldclass tldclass_'+itld+'" tld="'+itld+'"><i class="fa fa-refresh fa-spin"></i> đang k.tra</td>';
				html += '<td class="text-center domain_status" domain="'+item+'"><i class="fa fa-refresh fa-spin"></i> đang k.tra</td>';
				html += '<td class="text-center domain_action"><i class="fa fa-refresh fa-spin"></i> đang k.tra</td>';
			} else {
				html += '<td class="text-center"><span class="label label-danger">Conflicted</span></td>';
				html += '<td class="text-center"><span class="badge bg-danger">Conflicted</span></td>';
				html += '<td class="text-center"><a href="https://www.cloudone.vn/domain/loi-conflicted-domain-khi-dang-ky?ref=cloudone_register" target="_blank" class="btn btn-danger text-center"><i class="fa fa-warning"></i> Tại sao?</a></td>';
			}
			html += '</tr>';
		});
		$('#domain_table').html(html);
		$('.tldclass').each(function() {
			var n = $(this).attr('tld');
			n = n.replace('_', '.');
			if($.inArray(n, tld) == -1){
				tld.push(n);
			}
		});
		$.each(tld, function(key, item){
			$.post('/domain/ajax-get-price', {t: item}, function(data) {
				var res = $.parseJSON(data);
				var fixclass = item.replace('.', '_');
				if(res.result=='success'){
					$('.tldclass_'+fixclass).html(_pricefm(res.price.reg_price)+'/ Năm');
					reg_price[item] = res.price.reg_price;
					ren_price[item] = res.price.ren_price;
					min_reg[item] = res.price.reg_min;
					max_reg[item] = res.price.reg_max*1 + 1;
				} else {
					$('.tldclass_'+fixclass).html('<span class="label label-warning">'+res.msg+'</span>');
					not_sell.push(item);
				}
			});
		});
		$('.domain_status').each(function(){
			var elm = $(this);
			var dm = elm.attr('domain');
			var dm_act = elm.closest('tr').find('.domain_action');
			var itld = url('tld', dm);
			$.post('/domain/ajax-check', {domain: dm}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='error'){
					elm.html('<span class="badge bg-warning">Lỗi truy vấn</span>');
					dm_act.html('<a href="/domain/whois?d='+dm+'" target="_blank" class="btn btn-danger text-center"><i class="fa fa-eye"></i> Xem t.tin</a>');
				} else {
					if(res.msg==0){
						elm.html('<span class="badge bg-primary">Available</span>');
						if($.inArray(itld, not_sell) == -1){
							dm_act.html('<button class="btn btn-primary text-center sb_cart" domain="'+dm+'" action="add"><i class="fa fa-plus"></i> Chọn mua</button>');
						} else {
							dm_act.html('<button class="btn btn-danger text-center" disabled>Chưa bán loại này</button>');
						}
					} else {
						elm.html('<span class="badge bg-danger">Unavailable</span>');
						dm_act.html('<a href="/domain/whois?d='+dm+'" target="_blank" class="btn btn-danger text-center"><i class="fa fa-eye"></i> Xem t.tin</a>');
					}
				}
			});
		});	
	});
	$(document).on('click', '.sb_cart', function(){
		var domain = $(this).attr('domain');
		var itld = url('tld', domain);
		var action = $(this).attr('action');
		if($('#domain_addons').not(':visible')){
			$('#domain_addons').show(1000);
		}
		if(action==='add'){
			add_to_cart(domain, min_reg[itld]);
			update_sumary();
			$(this).html('<i class="fa fa-remove"></i> Bỏ chọn');
			$(this).attr('class', 'btn btn-warning text-center sb_cart');
			$(this).attr('action', 'remove');
			sbresult('info', 'Thêm '+domain+' vào giỏ hàng thành công!');
		} else if(action==='remove'){
			remove_from_cart(domain);
			update_sumary();
			$(this).html('<i class="fa fa-plus"></i> Chọn mua');
			$(this).attr('class', 'btn btn-primary text-center sb_cart');
			$(this).attr('action', 'add');
			sbresult('info', 'Xoá '+domain+' khỏi giỏ hàng thành công!');
		}
		if($.isEmptyObject(cart)){
			$('#domain_hav').hide();
			$('#domain_coupon').hide();
			$('#domain_no_domain').show();
		} else {
			$('#domain_no_domain').hide();
			$('#domain_coupon').show();
			$('#domain_hav').show();
			var html = '<div class="form-group"><label class="col-sm-2 control-label">Tên miền</label><div class="col-sm-10">';
			$.each(cart, function(item, value){
				itld = url('tld', item);
				html += '<div class="input-group mb15">';
				html += '<input type="text" class="form-control br0" value="'+item+'" disabled="disabled">';
				html += '<div class="input-group-btn">';
                html += '<button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-expanded="true">Số năm đ.ký <span class="caret"></span></button>';
                html += '<ul class="dropdown-menu pull-right">';
                for (var i=min_reg[itld]; i < max_reg[itld]; i++) {
                	html += '<li><a href="javascript:;" class="domain_add_years" domain="'+item+'" add="'+i+'">'+_pricefm(reg_price[itld]*1 + ren_price[itld]*(i-1))+'/'+i+' năm</a></li>';
				}
                html += '</ul></div></div>';
			});
			html += '</div></div>';
			$('#domain_hav').html(html);
		}
	});
	$(document).on('click', '.apply_domain_coupon', function(){
		var elm = $(this);
		coupon.code = $('#input_coupon').val();
		var pr = elm.parents('.form-group');
		if(!coupon.code){
			pr.removeClass().addClass('form-group has-error has-feedback');
			$('#input_coupon').val('');
			swal({title: "Đã có lỗi", text: "Vui lòng điền mã giảm giá hợp lệ nếu có", type: "warning"});
			coupon.code = false;
			return false;
		}
		$.post('/domain/ajax-coupon', {cop: coupon.code, cat: JSON.stringify(cart)}, function(data) {
			var res = $.parseJSON(data);
			if(res.result==='error'){
				pr.removeClass().addClass('form-group has-error has-feedback');
				$('#input_coupon').val('');
				swal({title: "Đã có lỗi", text: res.msg, type: "warning"});
				coupon.code = false;
			} else {
				pr.removeClass().addClass('form-group has-success has-feedback');
				$('#input_coupon').val(res.msg);
				$('#input_coupon').attr('disabled', true);
				coupon.value = res.value;
				elm.removeClass('btn-info apply_domain_coupon').addClass('btn-danger remove_domain_coupon');
				elm.html('Bỏ Mã K.Mãi');
				swal({title: "Thành công", text: res.msg, type: "success"});
				update_sumary();
			}
		});
	});
	$(document).on('click', '.remove_domain_coupon', function(){
		var elm = $(this);
		coupon.code = false;
		$('#input_coupon').removeAttr('value');
		$('#input_coupon').attr('placeholder', 'Nếu bạn có mã giảm giá, hãy điền vào');
		$('#input_coupon').val('');
		$('#input_coupon').attr('disabled', false);
		coupon.value = 0;
		elm.removeClass('btn-danger remove_domain_coupon').addClass('btn-info apply_domain_coupon');
		elm.html('Xác minh');
		update_sumary();
	});
	$(document).on('click', '.domain_add_years', function(){
		var dm = $(this).attr('domain');
		var ay = $(this).attr('add');
		add_to_cart(dm, ay);
		update_sumary();
	});
	$('#domain_confirm').on('click', function(){
		if($.isEmptyObject(cart)){
			return false;
		}
		swal({title: "Bạn chắc chứ?", text: "Bạn nên kiểm tra đơn hàng kỹ trước khi thanh toán", type: "warning", showCancelButton: true, confirmButtonColor: "#09c", confirmButtonText: "Thanh toán", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
			sbloading();
		    $.post('/domain/ajax-order', {cat: JSON.stringify(cart), cop: coupon.code}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					processing(res.domain, res.id);
				} else {
					sbresult('danger', res.msg);
				}
			});
		});
	});
})(jQuery);