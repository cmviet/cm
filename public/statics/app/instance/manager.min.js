function load_manager() {
	var n = $('#id').val();
	var srs = $('#srs').val();
	$.getJSON("/instance/ajax-manager?i="+n, function(data){
		if(data.result=='success'){
			if(data.msg.status===2){
				$(".btn").attr("disabled", true);
				$('#status').text('Đã bị đình chỉ');
				$('#status').removeClass().addClass('badge bg-warning');
				if(typeof srs === "undefined" || !srs){
					srs = 'Hệ thống không đưa ra lý do cụ thể';
				}
				$('#default').hide();
				$('#extra').html('<div class="alert alert-danger">Máy chủ của bạn đã bị đình chỉ hoạt động với lý do: <strong>'+srs+'</strong>.<br />Vui lòng liên hệ với hỗ trợ viên nhanh nhất có thể để tránh việc máy chủ bị xoá hoàn toàn sau thời gian dài bị đình chỉ mà không có sự liên hệ xử lý từ phía khách hàng!</div>');
				return false;
			} else {
				$(".btn").attr("disabled", false);
				$('#used_ram').text(data.msg.ram.used);
				$('#used_bw').text(data.msg.bandwidth.used_gb);
				$('#used_disk').text(data.msg.disk.used);
				$('#limit_disk').text(data.msg.disk.limit);
				var ram_percent = (data.msg.ram.used / data.msg.ram.limit) * 100;
				var disk_percent = (data.msg.disk.used / data.msg.disk.limit) * 100;
				$('#ram_percent').text(ram_percent);
				$('#disk_percent').text(disk_percent);
				$('.progress-bar-ram').attr("style","width: "+ram_percent+"%");
				$('.progress-bar-disk').attr("style","width: "+disk_percent+"%");
				$('.progress-bar-bw').attr("style","width: 100%");
				if(data.msg.status===1){
					$('#status').text('Đang hoạt động');
					$('#status').removeClass().addClass('badge bg-success');
					$('#uptime').text(data.msg.uptime);
					$('#used_load').text(data.msg.load);
					var load = data.msg.load.split(' ');
					var load_percent = (load[0] / 1) * 100;
					if(load_percent > 100) {load_percent = 100;}
					$('#load_percent').text(load_percent);
					$('.progress-bar-load').attr("style","width: "+load_percent+"%");
				} else {
					$('#status').text('Đang tắt');
					$('#uptime').text('Không rõ');
					$('#status').removeClass().addClass('badge bg-danger');
					$('#load_percent').text('0');
					$('.progress-bar-load').attr("style","width: 1%");
				}
			}
		} else {
			$('#default').hide();
			$('#extra').html('<div class="alert alert-danger"> <i class="fa fa-warning"> Lỗi kết nối với hệ thống, nếu lỗi lặp lại hãy liên hệ bộ phận kỹ thuật</div>');
		}
	});
}
function sbloading() {
	$('#loading').show();
	$('#loading').removeClass().addClass('alert alert-success');
	$('#loading').html('<i class="fa fa-refresh fa-spin"></i> Thao tác đang được thực hiện, vui lòng đợi chút...');
	$('.btn').attr('disabled', true);
	$("html, body").animate({ scrollTop: 0 }, "slow");
}
function sbresult(a, b) {
	$('#loading').removeClass().addClass('alert alert-'+a);
	$('#loading').html(b);
	$('.btn').attr('disabled', false);
	$('#loading').fadeTo(2000, 500).slideUp(1000, function(){
	    $('#loading').hide();
	});
}
function getPasswordStrength(pw){
    var pwlength=(pw.length);
    if(pwlength>5)pwlength=5;
    var numnumeric=pw.replace(/[0-9]/g,"");
    var numeric=(pw.length-numnumeric.length);
    if(numeric>3)numeric=3;
    var symbols=pw.replace(/\W/g,"");
    var numsymbols=(pw.length-symbols.length);
    if(numsymbols>3)numsymbols=3;
    var numupper=pw.replace(/[A-Z]/g,"");
    var upper=(pw.length-numupper.length);
    if(upper>3)upper=3;
    var pwstrength=((pwlength*10)-20)+(numeric*10)+(numsymbols*15)+(upper*10);
    if(pwstrength<0){pwstrength=0}
    if(pwstrength>100){pwstrength=100}
    return pwstrength;
}
function validhostname(str){
	if(str.length < 6){
		return false;
	}
	if(/^[a-zA-Z0-9-.]*$/.test(str) == false) {
	    return false;
	}
	return true;
}
function processing(type, hostname, id) {
	if(type==='destroy'){
		var mess = 'xoá';
	} else if(type==='reinstall'){
		var mess = 'cài lại hệ điều hành cho';
	}
	$('#instance_manager').html('<div class="panel"><div class="panel-heading border task_step"></div><div class="panel-body"><div class="progress"><div class="progress progress-striped active mb25"><div class="progress-bar animation--done" role="progressbar" style="width: 5%;"></div></div></div><div class="alert alert-info">Đang '+mess+' máy chủ '+hostname+' , rời khỏi trang không ảnh hưởng tới tiến trình!</div></div></div>');
	var current = 1;
	if(type==='destroy'){
    	var step = ['', 'Đang tắt hoàn toàn máy chủ...', 'Hoàn tất tắt máy chủ...', 'Đang xoá dữ liệu...', 'Hoàn tất xoá dữ liệu...', 'Đang bổ sung tài nguyên vào hệ thống...', 'Đang xoá các dữ liệu liên quan...', 'Đang dọn dẹp dữ liệu khách hàng...', 'Đang hoàn tất quá trình xoá dịch vụ...', 'Làm sạch tiến trình trước khi kết thúc...', 'Đang chuyển bạn tới danh sách máy chủ...'];
    } else if(type==='reinstall'){
		var step = ['', 'Đang tắt hoàn toàn máy chủ...', 'Hoàn tất tắt máy chủ...', 'Đang gắn ảnh đĩa của hệ điều hành mới...', 'Boot vào môi trường cài đặt hệ điều hành mới...', 'Đang hoàn tất cài đặt hệ điều hành...', 'Đang cấu hình kết nối mạng...', 'Hoàn tất kiểm tra kết nối mạng...', 'Hoàn tất xác minh và kết thúc quá trình cài đặt...', 'Làm sạch tiến trình trước khi kết thúc...', 'Đang chuyển bạn trở lại trang quản trị...'];
	}
    var interval = setInterval(function(){
		$('.task_step').text(step[current]);
		$('.progress-bar').attr("style","width: "+current*10+"%");
		if(current === 10) {
			if(type==='destroy'){
            	setTimeout(function(){window.location.replace('/instance/your-instance')}, 1000);
            } else if(type==='reinstall'){
            	setTimeout(function(){window.location.replace('/instance/manager/'+id)}, 1000);
            }
        }
        current++;
    },3000);
}
$('body').on('keyup', '#password', function () {
    var pwvalue = $("#password").val();
    var pwstrength = getPasswordStrength(pwvalue);
    if (pwstrength<=70) {
    	$("#pwstr").html("Trung bình");
    }
    if (pwstrength<30) {
    	$("#pwstr").html("Quá yếu");
    }
    if (pwstrength>70) {
    	$("#pwstr").html("Rất tốt");
    }
});
$('body').on('keyup', '#password2', function () {
    var pw = $("#password").val();
    var pw2 = $("#password2").val();
    if(pw == pw2){
    	$("#pw_cfm").html("Đã khớp");
    } else
    	$("#pw_cfm").html("Chưa khớp");
});
$('body').on('keyup', '#hostname', function () {
    var hn = $("#hostname").val();
    if(validhostname(hn)){
    	$("#hn_cfm").html("Hợp lệ");
    } else
    	$("#hn_cfm").html("Chưa hợp lệ");
});
$('.btn-do-action').on('click',function(){
	sbloading();
	var act = $(this).attr('id');
	var id = $('#id').val();
	$.post('/instance/ajax-do-action', {a: act, i: id}, function(data) {
		var res = $.parseJSON(data);
		if(res.result==='success'){
			load_manager();
			var type = 'info';
		} else {
			var type = 'danger';
		}
		sbresult(type, res.msg);
	});
});
$('body').on('click', '#back', function(){
	$('#extra').hide();
	$('#default').show();
});
$('button.btn-block').on('click',function(){
	var act = $(this).attr('id');
	var id = $('#id').val();
	var oid = $('#oid').val();
	var pid = $('#pid').val();
	$('#default').hide();
	$('#extra').html('<div class="panel"><div class="panel-heading border"><span id="extra-title"><i class="fa fa-refresh fa-spin"></i> Đang tải chức năng...</span><button class="btn btn-danger pull-right" id="back"><i class="fa fa-chevron-left"></i> Quay lại</button></div><div class="panel-body" id="extra-content"><div class="alert alert-info"><i class="fa fa-refresh fa-spin"></i> Vui lòng đợi chốc lát...</div></div></div>');
	$('#extra').show();
	$.post('/instance/ajax-extra-action', {a: act, i: id, o: oid, p: pid}, function(data) {
		var res = $.parseJSON(data);
		$('#extra-title').html('<strong>'+res.title+'</strong>')
		if(res.result === 'error'){
			$('#extra-content').html('<div class="alert alert-danger">'+res.msg+'</div>');
			return false
		}
		$('#extra-content').html(res.msg);
	});
});
$(function() {
	load_manager();
	setInterval(load_manager, 30000);
	$('body').on('click', '.extra-perform', function(){
		var inputs = $(':input');
		var values = {};
		var error = false;
	    inputs.each(function() {
	    	if(this.name){
	    		var type = $("input[name="+this.name+"]").attr('type');
	    		if(type === 'radio'){
	    			values[this.name] = $("input[name="+this.name+"]:checked").val();
	    		} else
	    		values[this.name] = $(this).val();
	    		if(!values[this.name]){
		    		error = true;
		    	}
	    	}
	    });
	    if(error) {
	    	swal({title: "Đã có lỗi", text: "Một hoặc một số thông tin bạn cung cấp không hợp lệ", type: "error"});
	    	return false;
	    }
	    var pw = $("#password").val();
    	var pw2 = $("#password2").val();
    	var hn = $("#hostname").val();
    	if($("#password").length && pw != pw2){
    		swal({title: "Đã có lỗi", text: "Mật khẩu bạn nhập 2 lần không giống nhau", type: "error"});
    		return false;
    	}
    	if($("#password").length && getPasswordStrength(pw) < 60){
    		swal({title: "Đã có lỗi", text: "Mật khẩu quá đơn giản, hãy chọn mật khẩu tốt hơn", type: "error"});
    		return false;
    	}
    	if($("#hostname").length && !validhostname(hn)){
    		swal({title: "Đã có lỗi", text: "Hostname không hợp lệ, hãy kiểm tra và thử lại", type: "error"});
    		return false;
    	}
	    swal({title: "Bạn chắc chứ?", text: "Hãy đảm bảo rằng bạn thực sự muốn thực hiện điều này!", type: "warning", showCancelButton: true, confirmButtonColor: "#DD6B55", confirmButtonText: "Thực hiện", cancelButtonText: "Để xem lại đã", closeOnConfirm: true},
		function(){
			sbloading();
		    $.post('/instance/ajax-extra-perform', {data: values}, function(data) {
				var res = $.parseJSON(data);
				if(res.result==='success'){
					var type = 'info';
				} else {
					var type = 'danger';
				}
				if(res.result==='success' && (res.type==='destroy' || res.type==='reinstall')){
					processing(res.type, res.hostname, res.id);
				} else {
					sbresult(type, res.msg);
				}
			});
		});
	});
});