(function($){'use strict';
	function getPasswordStrength(pw){
	    var pwlength=(pw.length);
	    if(pwlength>5)pwlength=5;
	    var numnumeric=pw.replace(/[0-9]/g,"");
	    var numeric=(pw.length-numnumeric.length);
	    if(numeric>3)numeric=3;
	    var symbols=pw.replace(/\W/g,"");
	    var numsymbols=(pw.length-symbols.length);
	    if(numsymbols>3)numsymbols=3;
	    var numupper=pw.replace(/[A-Z]/g,"");
	    var upper=(pw.length-numupper.length);
	    if(upper>3)upper=3;
	    var pwstrength=((pwlength*10)-20)+(numeric*10)+(numsymbols*15)+(upper*10);
	    if(pwstrength<0){pwstrength=0}
	    if(pwstrength>100){pwstrength=100}
	    return pwstrength;
	}
	function validhostname(str){
		if(str.length < 6){
			return false;
		}
		if(/^[a-zA-Z0-9-.]*$/.test(str) == false) {
		    return false;
		}
		return true;
	}
	function is_numeric(str){
	    return /^\d+$/.test(str);
	}
	function sb_pricefm(num){
		var out;
		if(!is_numeric(num)){
			return false;
		}
		if(num>1000000000){
			out = +((num / 1000000000).toFixed(1));
			out += 'b';
		} else if(num>1000000){
			out = +((num / 1000000).toFixed(1));
			out += 'm';
		} else if(num>1000){
			out = +((num / 1000).toFixed(1));
			out += 'k';
		} else {
			out = num;
			out += 'đ';
		}
		return out;
	}
	function plan_load(){
		var osid = $('#os').val();
		var bill = $('input[name=bill]:checked').val();
		var html;
		$.post("/instance/ajax-list-plan", {o: osid}, function(data) {
			var res = $.parseJSON(data);
			if(res.result=='success'){
				html = '<div class="row"><div class="btn-group col-md-12" data-toggle="buttons">';
				$.each(res.msg, function(){
					html += '<label class="col-md-3 col-sm-6 btn btn-default"><div class="panel-body"><div class="price">';
					if(bill==='h') {
						html += '<div class="hourly_price">';
						html += '<h2>'+sb_pricefm(this.hourly_active)+'</span><small>/giờ</small></h2>';
						html += '<small><strong>'+sb_pricefm(this.monthly_limit)+'</strong>/tháng</small>';
						html += '</div>';
						html += '<div class="monthly_price" style="display:none">';
						html += '<h2>'+sb_pricefm(this.monthly_limit)+'<small>/tháng</small></h2>';
						html += '<small><strong>'+sb_pricefm(this.hourly_active)+'</strong>/giờ</small>';
						html += '</div>';
					} else {
						html += '<div class="hourly_price" style="display:none">';
						html += '<h2>'+sb_pricefm(this.hourly_active)+'</span><small>/giờ</small></h2>';
						html += '<small><strong>'+sb_pricefm(this.monthly_limit)+'</strong>/tháng</small>';
						html += '</div>';
						html += '<div class="monthly_price">';
						html += '<h2>'+sb_pricefm(this.monthly_limit)+'<small>/tháng</small></h2>';
						html += '<small><strong>'+sb_pricefm(this.hourly_active)+'</strong>/giờ</small>';
						html += '</div>';
					}
					html += '</div><table class="table table-striped"><tbody><tr><td>'+this.ram+'GB RAM/ '+this.cpu+' Cores</td></tr><tr><td>'+this.disk+'GB SSD</td></tr><tr><td>'+this.bandwidth+'TB Bandwidth</td></tr></tbody></table>';
					html += '</div>';
					html += '<input type="radio" name="plan" value="'+this.id+'">';
					html += '</label>';
				});
				html += '</div></div>';
				$("#plan_list").html(html);
			} else {
				$("#plan_list").html('<div class="alert alert-info"> <i class="fa fa-warning"></i> '+res.msg+'</div>');
				return false
			}
	    })
	}
	$("#password").keyup(function () {
        var pwvalue = $("#password").val();
        var pwstrength = getPasswordStrength(pwvalue);
        if (pwstrength<=70) {
        	$("#pwstr").html("Trung bình");
        }
        if (pwstrength<30) {
        	$("#pwstr").html("Quá yếu");
        }
        if (pwstrength>70) {
        	$("#pwstr").html("Rất tốt");
        }
    });
    $("#password2").keyup(function () {
        var pw = $("#password").val();
        var pw2 = $("#password2").val();
        if(pw == pw2){
        	$("#pw_cfm").html("Đã khớp");
        } else
        	$("#pw_cfm").html("Chưa khớp");
    });
    $("#hostname").keyup(function () {
        var hn = $("#hostname").val();
        if(validhostname(hn)){
        	$("#hn_cfm").html("Hợp lệ");
        } else
        	$("#hn_cfm").html("Chưa hợp lệ");
    });
	$('#os').change(function() {
		var osid = $('#os').val();
		var bill = $('input[name=bill]:checked').val();
		if(!osid || !bill){
			$("#plan_list").html("<div class=\"alert alert-info\"> <i class=\"fa fa-warning\"></i> Vui lòng chọn hệ điều hành và chu kỳ thanh toán trước! </div>");
			return false;
		}
		$("#plan_list").html("<div class=\"alert alert-info\"> <i class=\"fa fa-refresh fa-spin\"></i> Đang tải... </div>");
		plan_load();
	});
	$("input:radio[name='bill']").change(function(){
		var bill = $(this).val();
		if(bill==='h'){
			$('.hourly_price').show();
			$('.monthly_price').hide();
		} else {
			$('.hourly_price').hide();
			$('.monthly_price').show();
		}
	});
	$('#btn-click').on('click',function(){
		var osid = $('#os').val();
		var bill = $('input[name=bill]:checked').val();
		var plan = $('input[name=plan]:checked').val();
		var hn = $('#hostname').val();
		var pw = $('#password').val();
		var pw2 = $('#password2').val();
		var pwst = getPasswordStrength(pw);
		if(!osid || !bill || !plan || !hn || !pw){
			swal('Đã có lỗi!','Chưa đủ thông tin cần thiết để xử lý yêu cầu!','error');return false
		}
		if(pw != pw2){
			swal('Đã có lỗi!','Mật khẩu của máy bạn nhập 2 lần không giống nhau','error');return false
		}
		if(pwst < 60){
			swal('Đã có lỗi!','Mật khẩu bạn đặt rất dễ đoán, khởi tạo thất bại','error');return false
		}
		if(!validhostname(hn)){
			swal('Đã có lỗi!','Tên máy (hostname) không hợp lệ, khởi tạo thất bại','error');return false
		}
		$('#btn-click').html('<i class="fa fa-refresh fa-spin"></i> Đợi chút nha...');
		$('#btn-click').prop('disabled', true);
		$.post("/instance/ajax-create", {o: osid, b: bill, p: plan, h: hn, m: pw}, function(data) {
			var res = $.parseJSON(data);
			if(res.result=='error'){
				$('#btn-click').html('Thử lại lần nữa');
				$('#btn-click').prop('disabled', false);
				swal('Đã có lỗi!',res.msg,'error');return false
			}
			$('#new_instance').html('<div class="panel"><div class="panel-heading border task_step"></div><div class="panel-body"><div class="progress"><div class="progress progress-striped active mb25"><div class="progress-bar animation--done" role="progressbar" style="width: 5%;"></div></div></div><div class="alert alert-info">Đang khởi tạo máy chủ '+res.hostname+' , rời khỏi trang không ảnh hưởng tới tiến trình!</div></div></div>');
			var current = 1;
            var step = ['', 'Đang chuẩn bị phần cứng...', 'Đang thiết lập tài nguyên...', 'Đang cài đặt hệ điều hành mới...', 'Đang hoàn tất cài đặt hệ điều hành...', 'Đang khởi động vào hệ điều hành...', 'Đang cấu hình các dịch vụ cơ bản...', 'Đang cấu hình mạng internet cho máy chủ...', 'Kiểm tra và xác nhận kết nối mạng hoàn tất...', 'Làm sạch tiến trình trước khi kết thúc...', 'Đang chuyển bạn tới máy chủ mới...'];
            var interval = setInterval(function(){
				$('.task_step').text(step[current]);
				$('.progress-bar').attr("style","width: "+current*10+"%");
				if(current === 10) {
		            setTimeout(function(){window.location.replace('/instance/manager/'+res.id)}, 1000);
		        }
		        current++;
		    },3000);
        })
	});
	$(document).keyup(function(event){
	    if(event.keyCode == 13){
	        $('#btn-click').click();
	    }
	});
	plan_load();
})(jQuery);